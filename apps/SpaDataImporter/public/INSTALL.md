# Руководство по установке приложения "SPA Data Importer" на новый портал Bitrix24

Это руководство описывает шаги для установки и настройки приложения для импорта данных в смарт-процессы на новом портале Bitrix24, когда приложение используется как "Локальное приложение" с индивидуальными ключами для каждого портала.

## Предпосылки

1.  Код приложения развернут на вашем веб-сервере и доступен по HTTPS. Пусть основной URL вашего приложения будет `https://your-app-server.com/path/to/importFromSpa/`.
2.  Вы имеете права администратора на портале Bitrix24, куда устанавливается приложение.

## Шаг 1: Регистрация локального приложения на портале Bitrix24

1.  Войдите в портал Bitrix24, на который вы хотите установить приложение.
2.  Перейдите в раздел "Приложения" (обычно в левом меню).
3.  В верхнем меню выберите "Разработчикам" (или "Market" -> "Добавить приложение" -> "Другое" -> "Локальное приложение" - путь может немного отличаться в зависимости от интерфейса Bitrix24).
    *   Если есть кнопка "Добавить приложение", нажмите ее.
    *   Выберите тип "Локальное приложение" (или "Серверное приложение", если такой вариант предлагается для приложений с UI и серверной частью – "Локальное" обычно подходит).
4.  **Заполнение формы регистрации приложения:**
    *   **Название вашего приложения:** Например, "SPA Data Importer - [Название Вашего Портала]" (чтобы вы могли их различать, если у вас несколько).
    *   **"Ваше приложение использует только API"**: **Снимите** эту галочку (так как у нас есть пользовательский интерфейс).
    *   **"Путь вашего обработчика" (URL приложения):** Укажите полный URL к главному файлу вашего приложения на вашем сервере.
        *   Пример: `https://app.technopeak.ae/applications/importToSpa/index.php`
    *   **"Путь для начальной установки" (URL установки):** Укажите тот же URL, что и выше.
        *   Пример: `https://app.technopeak.ae/applications/importToSpa/index.php`
    *   **"Путь для удаления приложения" (URL удаления, если есть):** Можно указать тот же URL. Ваш `index.php` должен будет обработать событие `ONAPPUNINSTALL`.
        *   Пример: `https://app.technopeak.ae/applications/importToSpa/index.php`
    *   **Права доступа (Scopes):** Выберите необходимые права. Как минимум:
        *   `crm` (Клиент-ориентированность (CRM)) - для работы со смарт-процессами, элементами, полями.
        *   `user` (Пользователи) - для получения информации о пользователях (например, для поля "Ответственный").
    *   Заполните остальные поля по необходимости (описание, иконки и т.д.).
5.  **Сохраните настройки приложения.**
6.  После сохранения Bitrix24 предоставит вам:
    *   **ID приложения (Application ID / client_id)**
    *   **Ключ приложения (Application Secret Key / client_secret)**
    **Скопируйте и надежно сохраните эти два значения. Они уникальны для этой установки на этом портале.**

## Шаг 2: Установка приложения на портале

1.  После регистрации приложения оно обычно появляется в списке "Установленные" или в разделе "Интеграции".
2.  Найдите ваше приложение и нажмите кнопку "Установить".
3.  Bitrix24 запросит подтверждение прав доступа, которые вы указали. Согласитесь.
4.  После этого Bitrix24 отправит POST-запрос на "Путь для начальной установки" (`index.php` вашего приложения) с первоначальными токенами (`AUTH_ID`, `REFRESH_ID`) и `member_id`.
5.  Ваш PHP-скрипт должен обработать этот запрос и сохранить токены. На этом этапе в файл `tokens_{member_id}.json` запишутся `client_id` и `client_secret` из вашего `config.php`. **Это еще не правильные ключи для данного портала.**

## Шаг 3: Ручное обновление `client_id` и `client_secret` в файле токенов

Это **самый важный и неудобный шаг** при данном подходе.

1.  **Определите `member_id` для текущей установки:**
    *   Когда приложение успешно установилось (или при первом его запуске), ваш PHP-скрипт создал файл `tokens_{member_id}.json` в папке `data/` на вашем сервере.
    *   Вы можете посмотреть в логах вашего PHP-скрипта (например, `error_log("AUTH_HANDLER_DEBUG: Tokens saved successfully from POST auth for member_id {$member_id}.");`) или найти файл по времени создания. `member_id` – это уникальный идентификатор установки на портале.
2.  **Найдите файл токенов:**
    *   На вашем сервере перейдите в папку `data/` вашего приложения.
    *   Найдите файл `tokens_{member_id}.json`, соответствующий `member_id` только что установленного приложения.
3.  **Отредактируйте файл токенов:**
    *   Откройте этот JSON-файл в текстовом редакторе.
    *   Найдите в нем поля `client_id` и `client_secret`.
    *   **Замените их значения** на те **ID приложения** и **Ключ приложения**, которые вы получили на **Шаге 1, Пункт 6** (уникальные для этого портала).
    *   Сохраните изменения в JSON-файле.

    Пример содержимого файла `tokens_{member_id}.json` **ПОСЛЕ** редактирования:
    ```json
    {
        "client_id": "local.xxxxxxxxxxxxxx.yyyyyy", // ID приложения, полученный от ЭТОГО портала
        "client_secret": "zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz", // Ключ приложения, полученный от ЭТОГО портала
        "domain": "yourportal.bitrix24.com",
        "access_token": "...",
        "expires_at": ...,
        "refresh_token": "...",
        "member_id": "...",
        "user_id": "...",
        "status": "..."
    }
    ```

## Шаг 4: Проверка работы приложения

1.  После ручного обновления `client_id` и `client_secret` в файле токенов, откройте приложение на портале Bitrix24.
2.  Оно должно корректно загрузиться.
3.  Проверьте его функциональность (загрузка списка смарт-процессов, полей, импорт).
4.  Обратите особое внимание на логику обновления токенов. Если токен протухнет, приложение должно успешно его обновить, используя теперь уже правильные `client_id` и `client_secret` из файла.

## Важные замечания

*   **Безопасность:** Хранение `client_secret` в файле `tokens_{member_id}.json` не является лучшей практикой с точки зрения безопасности. Обеспечьте максимальную защиту папки `data/` на вашем сервере от несанкционированного доступа.
*   **Обновление ключей:** Если по какой-то причине ключи приложения на портале Bitrix24 изменятся (хотя для локальных приложений это происходит редко, если вы их не перерегистрируете), вам нужно будет повторить Шаг 3.
*   **Удаление приложения:** При удалении приложения с портала, ваш скрипт (если обработчик `ONAPPUNINSTALL` настроен) должен удалить соответствующий файл `tokens_{member_id}.json` и другие связанные данные.

Этот метод требует ручного вмешательства, но позволяет использовать одно и то же приложение на нескольких порталах, если вы готовы выполнять эти шаги для каждой новой установки. Для большего удобства и безопасности рассмотрите возможность регистрации приложения в Маркетплейс Bitrix24 (даже как скрытого) для получения единых ключей.